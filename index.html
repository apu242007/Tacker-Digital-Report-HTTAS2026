<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tacker Solutions - Informe de Reparación</title>
    
    <!-- 1. Estilos y Librerías Externas (CDNs) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              tackerRed: '#d3121d',
              tackerDark: '#1a1a1a',
            }
          }
        }
      }
    </script>
    
    <!-- Babel para compilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. CSS Personalizado -->
    <style>
        @media print {
            .break-before-page {
                page-break-before: always;
            }
            .print\:hidden {
                display: none !important;
            }
            .print\:shadow-none {
                box-shadow: none !important;
            }
            .print\:w-full {
                width: 100% !important;
                max-width: none !important;
            }
            body {
                background-color: white;
            }
        }
        
        /* Fix para textarea autosize visual */
        textarea {
            field-sizing: content;
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
    <div id="root"></div>

    <!-- 3. Lógica de la Aplicación -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            FileText, ArrowRight, Settings, Printer, Save, 
            AlertTriangle, CheckCircle, XCircle, ArrowLeft,
            Camera, Trash2, Plus, Eraser 
        } from 'lucide-react';

        // --- LOGIC (logic.ts) ---
        const validateMeasurement = (check) => {
            if (!check.measuredValue || check.measuredValue.trim() === '') return 'empty';
            
            const val = parseFloat(check.measuredValue);
            if (isNaN(val)) return 'fail';

            if (check.nominalValue !== undefined && check.acceptableValue !== undefined) {
                if (check.acceptableValue < check.nominalValue) {
                    // Lower limit
                    return val >= check.acceptableValue ? 'ok' : 'fail';
                } else {
                    // Upper limit
                    return val <= check.acceptableValue ? 'ok' : 'fail';
                }
            }
            return 'ok';
        };

        const evaluateToolStatus = (data) => {
            const reasons = [];
            let isIncomplete = false;
            let isFail = false;

            // 1. Pre-Assembly
            data.preAssemblyChecks.forEach(check => {
                if (check.isYesNo) {
                    if (!check.checked) isIncomplete = true;
                } else if (check.hasMeasurement) {
                    const status = validateMeasurement(check);
                    if (status === 'fail') {
                        isFail = true;
                        reasons.push(`Medida fuera de rango: ${check.description} (${check.measuredValue})`);
                    } else if (status === 'empty') {
                        isIncomplete = true;
                    }
                }
            });

            // 2. Instruments
            data.instruments.forEach(inst => {
                if (inst.name && inst.status === 'VENC') {
                    isFail = true;
                    reasons.push(`Instrumento vencido: ${inst.name}`);
                }
                if (inst.name && !inst.status) isIncomplete = true;
            });

            if (isFail) return { status: 'NO APTO', reasons };
            if (isIncomplete) return { status: 'INCOMPLETO', reasons: ['Faltan datos de verificación'] };
            return { status: 'APTO', reasons: [] };
        };

        // --- CONSTANTS (constants.ts) ---
        const INITIAL_TRACEABILITY = [
            { id: '1', code: '0101 0078', description: 'Sello', lot: '', serie: '', checked: false, observations: '' },
            { id: '2', code: 'O-90-2-125', description: 'O Ring (X8)', lot: '', serie: '', checked: false, observations: '' },
            { id: '3', code: 'O-90-2-231', description: 'O Ring (X1)', lot: '', serie: '', checked: false, observations: '' },
            { id: '4', code: 'O-90-2-232', description: 'O Ring (X2)', lot: '', serie: '', checked: false, observations: '' },
            { id: '5', code: 'O-90-2-234', description: 'O Ring (X2)', lot: '', serie: '', checked: false, observations: '' },
            { id: '6', code: 'O-90-2-331', description: 'O Ring (X1)', lot: '', serie: '', checked: false, observations: '' },
            { id: '7', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
            { id: '8', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
            { id: '9', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
            { id: '10', code: '0000 0000 6003', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
            { id: '11', code: '0000 0000 6003', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
            { id: '12', code: '0000 0000 6003', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
            { id: '13', code: '0000 0000 1007', description: 'Mordaza', lot: '', serie: '', checked: false, observations: '' },
            { id: '14', code: '0000 0000 1007', description: 'Mordaza', lot: '', serie: '', checked: false, observations: '' },
            { id: '15', code: '0000 0000 1007', description: 'Mordaza', lot: '', serie: '', checked: false, observations: '' },
            { id: '16', code: '0000 0000 8021', description: 'Blocks de Arrastre', lot: '', serie: '', checked: false, observations: '' },
            { id: '17', code: '0000 0000 8021', description: 'Blocks de Arrastre', lot: '', serie: '', checked: false, observations: '' },
            { id: '18', code: '0101 0011', description: 'Anillo retencion flejes', lot: '', serie: '', checked: false, observations: '' },
            { id: '19', code: '0101 0019', description: 'Anillo Calibrador Superior', lot: '', serie: '', checked: false, observations: '' },
            { id: '20', code: '0101 5000 0001', description: 'Cabezal Superior 2 7/8 EUE Box', lot: '', serie: '', checked: false, observations: '' },
            { id: '21', code: '0101 5000 0005', description: 'Mandril', lot: '', serie: '', checked: false, observations: '' },
            { id: '22', code: '0101 5000 0010', description: 'Porta Piston', lot: '', serie: '', checked: false, observations: '' },
            { id: '23', code: '0101 5000 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
            { id: '24', code: '0101 5000 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
            { id: '25', code: '0101 5000 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
            { id: '26', code: '0101 5000 0021', description: 'Camisa Porta Gomas', lot: '', serie: '', checked: false, observations: '' },
            { id: '27', code: '0101 5000 0025', description: 'Cono Portamordazas', lot: '', serie: '', checked: false, observations: '' },
            { id: '28', code: '0101 5000 0030', description: 'Camisa Jota', lot: '', serie: '', checked: false, observations: '' },
            { id: '29', code: '0101 5000 0035', description: 'Pin De Jota', lot: '', serie: '', checked: false, observations: '' },
            { id: '30', code: '0000 0000 2007', description: 'Resorte (X16)', lot: '', serie: '', checked: false, observations: '' },
            { id: '31', code: '0000 0000 5007', description: 'Tornillo (X4)', lot: '', serie: '', checked: false, observations: '' },
        ];

        const INITIAL_CHECKS = [
            { id: 1, description: 'Verificar visualmente estado de mordazas y conos portamordazas', isYesNo: true, hasMeasurement: false },
            { id: 2, description: 'Verificar visualmente estado de roscas (Foto 1)', isYesNo: true, hasMeasurement: false },
            { id: 3, description: 'Verificar estado de pistones y alojamientos con Calibres P/NP', isYesNo: true, hasMeasurement: false },
            { id: 4, description: 'Verificar cantidad y estado de O rings. (Foto 2)', isYesNo: true, hasMeasurement: false },
            { id: 5, description: 'Verificar estado de las secciones pulidas donde trabajan los O rings', isYesNo: true, hasMeasurement: false },
            { id: 6, description: 'Realizar prueba hidráulica y adjuntar registro', isYesNo: true, hasMeasurement: false },
            { id: 7, description: 'Inspeccionar y realizar control dimensional al Mandril.', isYesNo: false, hasMeasurement: true, nominalValue: 399, acceptableValue: 400, nominalUnit: 'mm' },
            { id: 8, description: 'Verificar y realizar control dimensional al Camisa Porta Balanceadora (Detalle A)', isYesNo: false, hasMeasurement: true, nominalValue: 153.5, acceptableValue: 152.5, nominalUnit: 'mm' },
            { id: 9, description: 'Verificar y realizar control dimensional al Camisa Porta Balanceadora (Detalle B)', isYesNo: false, hasMeasurement: true, nominalValue: 4.0, acceptableValue: 3.8, nominalUnit: 'mm' },
            { id: 10, description: 'Inspeccionar y realizar control dimensional a Camisa Balanceadora Superior (0101-5000-0038)', isYesNo: false, hasMeasurement: true, nominalValue: 128, acceptableValue: 127.5, nominalUnit: 'mm' },
            { id: 11, description: 'Inspeccionar y realizar control dimensional a Camisa Balanceadora Inferior (0101-5000-0008)', isYesNo: false, hasMeasurement: true, nominalValue: 114, acceptableValue: 113.5, nominalUnit: 'mm' },
            { id: 12, description: 'Verificar correcto ensamble de Camisas Balanceadoras (Foto 3)', isYesNo: true, hasMeasurement: false },
            { id: 13, description: 'Inspeccionar estado de block de arrastre', isYesNo: true, hasMeasurement: false },
            { id: 14, description: 'Inspeccionar estado de porta block', isYesNo: true, hasMeasurement: false },
            { id: 15, description: 'Verificar torque a todas las uniones, tornillos y prisioneros', isYesNo: true, hasMeasurement: false },
        ];

        const INITIAL_TRACEABILITY_0178 = [
          { id: '1', code: '0101 0078', description: 'Sello', lot: '', serie: '', checked: false, observations: '' },
          { id: '2', code: 'O-90-2-125', description: 'O Ring (X8)', lot: '', serie: '', checked: false, observations: '' },
          { id: '3', code: 'O-90-2-231', description: 'O Ring (X1)', lot: '', serie: '', checked: false, observations: '' },
          { id: '4', code: 'O-90-2-234', description: 'O Ring (X2)', lot: '', serie: '', checked: false, observations: '' },
          { id: '5', code: 'O-90-2-235', description: 'O Ring (X2)', lot: '', serie: '', checked: false, observations: '' },
          { id: '6', code: 'O-90-2-331', description: 'O Ring (X1)', lot: '', serie: '', checked: false, observations: '' },
          { id: '7', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
          { id: '8', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
          { id: '9', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
          { id: '10', code: '0000 0000 6003', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
          { id: '11', code: '0000 0000 6003', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
          { id: '12', code: '0000 0000 6003', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
          { id: '13', code: '0000 0000 6003', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
          { id: '14', code: '0000 0000 6003', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
          { id: '15', code: '0000 0000 6003', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
          { id: '16', code: '0000 0000 1007', description: '* Mordaza', lot: '', serie: '', checked: false, observations: '' },
          { id: '17', code: '0000 0000 1007', description: '* Mordaza', lot: '', serie: '', checked: false, observations: '' },
          { id: '18', code: '0000 0000 1007', description: '* Mordaza', lot: '', serie: '', checked: false, observations: '' },
          { id: '19', code: '0000 0000 8021', description: 'Blocks de Arrastre', lot: '', serie: '', checked: false, observations: '' },
          { id: '20', code: '0000 0000 8021', description: 'Blocks de Arrastre', lot: '', serie: '', checked: false, observations: '' },
          { id: '21', code: '0000 0000 8021', description: 'Blocks de Arrastre', lot: '', serie: '', checked: false, observations: '' },
          { id: '22', code: '0178 0011', description: 'Anillo retencion flejes', lot: '', serie: '', checked: false, observations: '' },
          { id: '23', code: '0101 0019', description: 'Anillo Calibrador Superior', lot: '', serie: '', checked: false, observations: '' },
          { id: '24', code: '0101 0017', description: 'Anillos Separadores', lot: '', serie: '', checked: false, observations: '' },
          { id: '25', code: '0101 0017', description: 'Anillos Separadores', lot: '', serie: '', checked: false, observations: '' },
          { id: '26', code: '0101 0023', description: 'Anillo Calibrador Inferior', lot: '', serie: '', checked: false, observations: '' },
          { id: '27', code: '0178 5000 0001', description: '* Cabezal Superior 2 7/8 TSH PH-6 Box', lot: '', serie: '', checked: false, observations: '' },
          { id: '28', code: '0101 5000 0003', description: 'Tuerca Porta Sello', lot: '', serie: '', checked: false, observations: '' },
          { id: '29', code: '0178 5000 0005', description: '* Mandril', lot: '', serie: '', checked: false, observations: '' },
          { id: '30', code: '0178 5000 0007', description: 'Camisa Porta Balanceadora Superior', lot: '', serie: '', checked: false, observations: '' },
          { id: '31', code: '0178 5000 0008', description: 'Camisa Balanceadora Inferior', lot: '', serie: '', checked: false, observations: '' },
          { id: '32', code: '0178 5000 0010', description: 'Porta Piston', lot: '', serie: '', checked: false, observations: '' },
          { id: '33', code: '0101 5000 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
          { id: '34', code: '0101 5000 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
          { id: '35', code: '0101 5000 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
          { id: '36', code: '0101 5000 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
          { id: '37', code: '0101 5000 0021', description: '* Camisa Porta Gomas', lot: '', serie: '', checked: false, observations: '' },
          { id: '38', code: '0101 5000 0022', description: 'Anillo Retenedor Fleje', lot: '', serie: '', checked: false, observations: '' },
          { id: '39', code: '0101 5000 0025', description: 'Cono Portamordazas', lot: '', serie: '', checked: false, observations: '' },
          { id: '40', code: '0101 5000 0028', description: 'Anillo Porta Mordazas', lot: '', serie: '', checked: false, observations: '' },
          { id: '41', code: '0101 5000 0030', description: 'Camisa Jota', lot: '', serie: '', checked: false, observations: '' },
          { id: '42', code: '0101 5000 0032', description: 'Anillo Retencion Block', lot: '', serie: '', checked: false, observations: '' },
          { id: '43', code: '0101 5000 0035', description: '* Pin De Jota', lot: '', serie: '', checked: false, observations: '' },
          { id: '44', code: '0178 5000 0036', description: 'Camisa Porta Balanceadora Inferior', lot: '', serie: '', checked: false, observations: '' },
          { id: '45', code: '0178 5000 0038', description: 'Camisa Balanceadora Superior', lot: '', serie: '', checked: false, observations: '' },
          { id: '46', code: '0101 5000 0039', description: 'Camisaprotectora Jota', lot: '', serie: '', checked: false, observations: '' },
          { id: '47', code: '0000 0000 2007', description: 'Resorte (X16)', lot: '', serie: '', checked: false, observations: '' },
          { id: '48', code: '0000 0000 2011', description: 'Resorte (X8)', lot: '', serie: '', checked: false, observations: '' },
          { id: '49', code: '0000 0000 5007', description: 'Tornillo (X4)', lot: '', serie: '', checked: false, observations: '' },
          { id: '50', code: '0000 0000 5011', description: 'Tornillo (X2)', lot: '', serie: '', checked: false, observations: '' },
          { id: '51', code: '0000 0000 5038', description: 'Tornillo (X4)', lot: '', serie: '', checked: false, observations: '' },
        ];

        const INITIAL_CHECKS_0178 = [
          { id: 1, description: 'Verificar visualmente estado de mordazas y conos portamordazas', isYesNo: true, hasMeasurement: false },
          { id: 2, description: 'Verificar visualmente estado de roscas (Foto 1)', isYesNo: true, hasMeasurement: false },
          { id: 3, description: 'Verificar estado de pistones y alojamientos con Calibres P/NP', isYesNo: true, hasMeasurement: false },
          { id: 4, description: 'Verificar cantidad y estado de O rings. (Foto 2)', isYesNo: true, hasMeasurement: false },
          { id: 5, description: 'Verificar estado de las secciones pulidas donde trabajan los O rings', isYesNo: true, hasMeasurement: false },
          { id: 6, description: 'Realizar prueba hidráulica y adjuntar registro', isYesNo: true, hasMeasurement: false },
          { id: 7, description: 'Inspeccionar y realizar control dimensional al Mandril.', isYesNo: false, hasMeasurement: true, nominalValue: 399, acceptableValue: 401, nominalUnit: 'mm' },
          { id: 8, description: 'Verificar y realizar control dimensional al Camisa Porta Balanceadora Superior. Detalle A:', isYesNo: false, hasMeasurement: true, nominalValue: 154.9, acceptableValue: 153.9, nominalUnit: 'mm' },
          { id: 9, description: 'Detalle B:', isYesNo: false, hasMeasurement: true, nominalValue: 4.0, acceptableValue: 3.8, nominalUnit: 'mm' },
          { id: 10, description: 'Detalle C:', isYesNo: false, hasMeasurement: true, nominalValue: 1.8, acceptableValue: 2.1, nominalUnit: 'mm' },
          { id: 11, description: 'Inspeccionar y realizar control dimensional a Camisa Balanceadora Superior (0178-5000-0038).', isYesNo: false, hasMeasurement: true, nominalValue: 128, acceptableValue: 127, nominalUnit: 'mm' },
          { id: 12, description: 'Inspeccionar y realizar control dimensional a Camisa Balanceadora Inferior (0178-5000-0008).', isYesNo: false, hasMeasurement: true, nominalValue: 105.5, acceptableValue: 104.5, nominalUnit: 'mm' },
          { id: 13, description: 'Verificar correcto ensamble de Camisas Balanceadoras con  Camisas Porta Balanceadora (Foto 3)', isYesNo: true, hasMeasurement: false },
          { id: 14, description: 'Inspeccionar visualmente Tetones del Pin de Jota', isYesNo: true, hasMeasurement: false },
          { id: 15, description: 'Inspeccionar estado de block de arrastre', isYesNo: true, hasMeasurement: false },
          { id: 16, description: 'Inspeccionar estado de porta block', isYesNo: true, hasMeasurement: false },
          { id: 17, description: 'Verificar torque a todas las uniones, tornillos y prisioneros.', isYesNo: true, hasMeasurement: false },
        ];
        
        const INITIAL_INSTRUMENTS = [
            { id: '1', name: 'Pie de Rey', code: 'CAL-DIG-300-C1', expiration: '', status: 'VENC' },
            { id: '2', name: 'Durometro', code: '', expiration: '', status: 'VENC' },
            { id: '3', name: 'Cinta Métrica', code: 'CINTA-MET-C1', expiration: '', status: 'VENC' },
            { id: '4', name: 'Manometro', code: '', expiration: '', status: 'VENC' },
            { id: '5', name: 'Conejo', code: 'CONEJO-177-C1', expiration: '', status: 'VENC' },
            { id: '6', name: 'P/NP Porta Pistón', code: '0101-5000-0051', expiration: '', status: 'VENC' },
            { id: '7', name: 'P/NP Pistón', code: '0101-5000-0052', expiration: '', status: 'VENC' },
            { id: '8', name: '', code: '', expiration: '', status: '' },
        ];
        
        const INITIAL_TRACEABILITY_5500 = [
            { id: '1', code: '0101 0079', description: 'Sello', lot: '', serie: '', checked: false, observations: '' },
            { id: '2', code: 'O-90-2-224', description: 'O Ring (X8)', lot: '', serie: '', checked: false, observations: '' },
            { id: '3', code: 'O-90-2-332', description: 'O Ring (X1)', lot: '', serie: '', checked: false, observations: '' },
            { id: '4', code: 'O-90-2-336', description: 'O Ring (X1)', lot: '', serie: '', checked: false, observations: '' },
            { id: '5', code: 'O-90-2-337', description: 'O Ring (X1)', lot: '', serie: '', checked: false, observations: '' },
            { id: '6', code: 'O-90-2-340', description: 'O Ring (X1)', lot: '', serie: '', checked: false, observations: '' },
            { id: '7', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
            { id: '8', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
            { id: '9', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
            { id: '10', code: '0101', description: 'Goma', lot: '', serie: '', checked: false, observations: 'Dureza Registrada: ' },
            { id: '11', code: '0000 0000', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
            { id: '12', code: '0000 0000', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
            { id: '13', code: '0000 0000', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
            { id: '14', code: '0000 0000', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
            { id: '15', code: '0000 0000', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
            { id: '16', code: '0000 0000', description: 'Pistón', lot: '', serie: '', checked: false, observations: '' },
            { id: '17', code: '0000 0000 1005', description: '* Mordaza', lot: '', serie: '', checked: false, observations: '' },
            { id: '18', code: '0000 0000 1005', description: '* Mordaza', lot: '', serie: '', checked: false, observations: '' },
            { id: '19', code: '0000 0000 1005', description: '* Mordaza', lot: '', serie: '', checked: false, observations: '' },
            { id: '20', code: '0000 0000 1005', description: '* Mordaza', lot: '', serie: '', checked: false, observations: '' },
            { id: '21', code: '0000 0000 8002', description: 'Blocks de Arrastre', lot: '', serie: '', checked: false, observations: '' },
            { id: '22', code: '0000 0000 8002', description: 'Blocks de Arrastre', lot: '', serie: '', checked: false, observations: '' },
            { id: '23', code: '0000 0000 8002', description: 'Blocks de Arrastre', lot: '', serie: '', checked: false, observations: '' },
            { id: '24', code: '0000 0000 8002', description: 'Blocks de Arrastre', lot: '', serie: '', checked: false, observations: '' },
            { id: '25', code: '0101 0011', description: 'Anillo retencion flejes', lot: '', serie: '', checked: false, observations: '' },
            { id: '26', code: '0101 0019', description: 'Anillo Calibrador Superior', lot: '', serie: '', checked: false, observations: '' },
            { id: '27', code: '0101 0017', description: 'Anillos Separadores', lot: '', serie: '', checked: false, observations: '' },
            { id: '28', code: '0101 0017', description: 'Anillos Separadores', lot: '', serie: '', checked: false, observations: '' },
            { id: '29', code: '0101 0023', description: 'Anillo Calibrador Inferior', lot: '', serie: '', checked: false, observations: '' },
            { id: '30', code: '0101 5500 0001', description: '* Cabezal Superior 2 7/8" EUE Box', lot: '', serie: '', checked: false, observations: '' },
            { id: '31', code: '0101 5500 0003', description: 'Tuerca Porta Sello', lot: '', serie: '', checked: false, observations: '' },
            { id: '32', code: '0101 5500 0005', description: '* Mandril', lot: '', serie: '', checked: false, observations: '' },
            { id: '33', code: '0101 5500 0007', description: 'Camisa Porta Balanceadora', lot: '', serie: '', checked: false, observations: '' },
            { id: '34', code: '0101 5500 0008', description: 'Camisa Balanceadora', lot: '', serie: '', checked: false, observations: '' },
            { id: '35', code: '0101 5500 0010', description: 'Porta Piston', lot: '', serie: '', checked: false, observations: '' },
            { id: '36', code: '0101 5500 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
            { id: '37', code: '0101 5500 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
            { id: '38', code: '0101 5500 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
            { id: '39', code: '0101 5500 0012', description: 'Fleje', lot: '', serie: '', checked: false, observations: '' },
            { id: '40', code: '0101 5500 0021', description: '* Camisa Porta Gomas', lot: '', serie: '', checked: false, observations: '' },
            { id: '41', code: '0101 5500 0022', description: 'Anillo Retenedor Fleje', lot: '', serie: '', checked: false, observations: '' },
            { id: '42', code: '0101 5500 0024', description: 'Camisa Union', lot: '', serie: '', checked: false, observations: '' },
            { id: '43', code: '0101 5500 0025', description: 'Cono Portamordazas', lot: '', serie: '', checked: false, observations: '' },
            { id: '44', code: '0101 5500 0028', description: 'Anillo Porta Mordazas', lot: '', serie: '', checked: false, observations: '' },
            { id: '45', code: '0101 5500 0030', description: 'Camisa Jota', lot: '', serie: '', checked: false, observations: '' },
            { id: '46', code: '0101 5500 0032', description: 'Anillo Retención Block Superior', lot: '', serie: '', checked: false, observations: '' },
            { id: '47', code: '0101 5500 0035', description: '* Pin De Jota', lot: '', serie: '', checked: false, observations: '' },
            { id: '48', code: '0000 0000 2006', description: 'Resorte (X16)', lot: '', serie: '', checked: false, observations: '' },
            { id: '49', code: '0000 0000 2019', description: 'Resorte (X16)', lot: '', serie: '', checked: false, observations: '' },
            { id: '50', code: '0000 0000 5008', description: 'Tornillo (X4)', lot: '', serie: '', checked: false, observations: '' },
            { id: '51', code: '0000 0000 5011', description: 'Tornillo (X2)', lot: '', serie: '', checked: false, observations: '' },
            { id: '52', code: '0000 0000 5038', description: 'Tornillo (X4)', lot: '', serie: '', checked: false, observations: '' },
            { id: '53', code: '0000 0000 5039', description: 'Tornillo (X4)', lot: '', serie: '', checked: false, observations: '' },
            { id: '54', code: '0000 0000 5533', description: 'Tornillo (X2)', lot: '', serie: '', checked: false, observations: '' },
        ];

        const INITIAL_CHECKS_5500 = [
            { id: 1, description: 'Verificar visualmente estado de mordazas y conos portamordazas', isYesNo: true, hasMeasurement: false },
            { id: 2, description: 'Verificar visualmente estado de roscas (Foto 1)', isYesNo: true, hasMeasurement: false },
            { id: 3, description: 'Verificar estado de pistones y alojamientos con Calibres P/NP', isYesNo: true, hasMeasurement: false },
            { id: 4, description: 'Verificar cantidad y estado de O rings. (Foto 2)', isYesNo: true, hasMeasurement: false },
            { id: 5, description: 'Verificar estado de las secciones pulidas donde trabajan los O rings', isYesNo: true, hasMeasurement: false },
            { id: 6, description: 'Realizar prueba hidráulica y adjuntar registro', isYesNo: true, hasMeasurement: false },
            { id: 7, description: 'Inspeccionar y realizar control dimensional al Mandril.', isYesNo: false, hasMeasurement: true, nominalValue: 272.5, acceptableValue: 274.5, nominalUnit: 'mm' },
            { id: 8, description: 'Verificar y realizar control dimensional al Camisa Porta Balanceadora. Detalle A:', isYesNo: false, hasMeasurement: true, nominalValue: 195, acceptableValue: 191, nominalUnit: 'mm' },
            { id: 9, description: 'Detalle B:', isYesNo: false, hasMeasurement: true, nominalValue: 4.3, acceptableValue: 4.1, nominalUnit: 'mm' },
            { id: 10, description: 'Detalle C:', isYesNo: false, hasMeasurement: true, nominalValue: 1.7, acceptableValue: 2.0, nominalUnit: 'mm' },
            { id: 11, description: 'Inspeccionar y realizar control dimensional a Camisa Balanceadora.', isYesNo: false, hasMeasurement: true, nominalValue: 90.5, acceptableValue: 89.5, nominalUnit: 'mm' },
            { id: 12, description: 'Inspeccionar visualmente Tetones del Pin de Jota', isYesNo: true, hasMeasurement: false },
            { id: 13, description: 'Inspeccionar estado de block de arrastre', isYesNo: true, hasMeasurement: false },
            { id: 14, description: 'Inspeccionar estado de porta block', isYesNo: true, hasMeasurement: false },
            { id: 15, description: 'Verificar torque a todas las uniones, tornillos y prisioneros.', isYesNo: true, hasMeasurement: false },
        ];
        
        // --- COMPONENTS ---

        const SignaturePad = ({ value, onChange, label }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [ctx, setCtx] = useState(null);

            useEffect(() => {
                if (canvasRef.current) {
                    const canvas = canvasRef.current;
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                    const context = canvas.getContext('2d');
                    if (context) {
                        context.lineWidth = 2;
                        context.lineCap = 'round';
                        context.strokeStyle = '#000000';
                        setCtx(context);
                    }
                }
            }, []);

            useEffect(() => {
                if (value && canvasRef.current && ctx) {
                    const image = new Image();
                    image.onload = () => {
                        ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
                        ctx.drawImage(image, 0, 0);
                    };
                    image.src = value;
                } else if (!value && canvasRef.current && ctx) {
                    ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
                }
            }, [value, ctx]);

            const startDrawing = (e) => {
                setIsDrawing(true);
                draw(e);
            };

            const stopDrawing = () => {
                setIsDrawing(false);
                if (ctx) {
                    ctx.beginPath();
                    if (canvasRef.current) onChange(canvasRef.current.toDataURL());
                }
            };

            const draw = (e) => {
                if (!isDrawing || !ctx || !canvasRef.current) return;
                e.preventDefault();
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                let x, y;
                if (e.touches) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            };

            const clear = () => {
                if (ctx && canvasRef.current) {
                    ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
                    onChange('');
                }
            };

            return (
                <div className="w-full">
                    {label && <div className="text-sm font-bold mb-1">{label}</div>}
                    <div className="relative border border-gray-400 border-dashed bg-white h-32 w-full touch-none group">
                        <canvas
                            ref={canvasRef}
                            className="w-full h-full cursor-crosshair"
                            onMouseDown={startDrawing}
                            onMouseUp={stopDrawing}
                            onMouseMove={draw}
                            onMouseLeave={stopDrawing}
                            onTouchStart={startDrawing}
                            onTouchEnd={stopDrawing}
                            onTouchMove={draw}
                        />
                        {!value && !isDrawing && (
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20 text-gray-500 font-bold uppercase text-xs">
                                Firmar Aquí
                            </div>
                        )}
                        {(value || isDrawing) && (
                            <button onClick={clear} className="absolute top-1 right-1 p-1 bg-white border border-gray-300 rounded hover:bg-red-50 text-red-500 print:hidden opacity-0 group-hover:opacity-100 transition-opacity">
                                <Eraser size={14} />
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const PhotoPlaceholder = ({ title, images, onAdd, onRemove }) => {
            const fileInputRef = useRef(null);

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    const files = Array.from(e.target.files);
                    const promises = files.map((file) => {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                if (ev.target && ev.target.result) resolve(ev.target.result);
                            };
                            reader.readAsDataURL(file);
                        });
                    });
                    Promise.all(promises).then(base64Images => {
                        onAdd(base64Images);
                        if (fileInputRef.current) fileInputRef.current.value = '';
                    });
                }
            };

            return (
                <div className="border border-black break-inside-avoid bg-white">
                    <div className="p-1 text-sm font-bold border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                        <span>{title}</span>
                        <span className="text-xs text-gray-500 font-normal print:hidden">
                            {images.length} {images.length === 1 ? 'foto' : 'fotos'}
                        </span>
                    </div>
                    <div className="p-2">
                        {images.length > 0 && (
                            <div className="grid grid-cols-2 gap-2 mb-2">
                                {images.map((img, idx) => (
                                    <div key={idx} className="relative group aspect-square border border-gray-200 rounded overflow-hidden">
                                        <img src={img} alt={`Foto ${idx + 1}`} className="w-full h-full object-cover" />
                                        <button onClick={() => onRemove(idx)} className="absolute top-1 right-1 bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity print:hidden">
                                            <Trash2 size={14} />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                        <div onClick={() => fileInputRef.current && fileInputRef.current.click()} className="h-24 border-2 border-dashed border-gray-300 rounded flex flex-col items-center justify-center text-gray-400 hover:bg-gray-50 hover:border-gray-400 cursor-pointer transition print:hidden">
                            <input type="file" multiple accept="image/*" className="hidden" ref={fileInputRef} onChange={handleFileChange} />
                            {images.length === 0 ? (
                                <><Camera size={32} /><span className="mt-1 text-xs">Click para agregar fotos</span></>
                            ) : (
                                <><Plus size={24} /><span className="mt-1 text-xs">Agregar más</span></>
                            )}
                        </div>
                        {images.length === 0 && (
                            <div className="hidden print:flex h-[200px] items-center justify-center text-gray-300 italic text-xs">
                                Sin imágenes adjuntas
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const InstrumentsTable = ({ instruments, onChange }) => {
            const midPoint = Math.ceil(instruments.length / 2);
            const leftColumn = instruments.slice(0, midPoint);
            const rightColumn = instruments.slice(midPoint);

            const renderRow = (item) => (
                <tr key={item.id} className="border-b border-gray-200">
                    <td className="border-r border-gray-300 p-1 text-xs bg-gray-50">{item.name}</td>
                    <td className="border-r border-gray-300 p-1 text-xs">
                        <input type="text" value={item.code} onChange={(e) => onChange(item.id, 'code', e.target.value)} className="w-full bg-transparent outline-none font-mono" placeholder="-" />
                    </td>
                    <td className="border-r border-gray-300 p-1 w-20">
                        <input type="date" value={item.expiration} onChange={(e) => onChange(item.id, 'expiration', e.target.value)} className="w-full bg-transparent outline-none text-center text-xs" />
                    </td>
                    <td className={`p-1 w-16 text-center text-xs font-bold ${item.status === 'VENC' ? 'bg-red-500 text-white' : item.status === 'OK' ? 'bg-green-100 text-green-800' : 'bg-white'}`}>
                        <select value={item.status} onChange={(e) => onChange(item.id, 'status', e.target.value)} className="bg-transparent outline-none w-full appearance-none text-center cursor-pointer">
                            <option value=""></option>
                            <option value="VENC">VENC</option>
                            <option value="OK">OK</option>
                        </select>
                    </td>
                </tr>
            );

            return (
                <div className="mt-4">
                    <div className="bg-tackerRed text-white font-bold px-2 py-1 text-sm uppercase mb-0">6.1. Instrumentos Utilizados</div>
                    <div className="flex border border-gray-300 border-t-0 bg-white">
                        <div className="w-1/2 border-r border-gray-300">
                            <table className="w-full border-collapse table-fixed">
                                <thead>
                                    <tr className="bg-gray-100 text-xs border-b border-gray-300">
                                        <th className="border-r border-gray-300 p-1 text-left w-1/3">Instrumento</th>
                                        <th className="border-r border-gray-300 p-1 text-left">Código</th>
                                        <th className="border-r border-gray-300 p-1 w-20">F. Vencimiento</th>
                                        <th className="p-1 w-16">Estado</th>
                                    </tr>
                                </thead>
                                <tbody>{leftColumn.map(renderRow)}</tbody>
                            </table>
                        </div>
                        <div className="w-1/2">
                            <table className="w-full border-collapse table-fixed">
                                <thead>
                                    <tr className="bg-gray-100 text-xs border-b border-gray-300">
                                        <th className="border-r border-gray-300 p-1 text-left w-1/3">Instrumento</th>
                                        <th className="border-r border-gray-300 p-1 text-left">Código</th>
                                        <th className="border-r border-gray-300 p-1 w-20">F. Vencimiento</th>
                                        <th className="p-1 w-16">Estado</th>
                                    </tr>
                                </thead>
                                <tbody>{rightColumn.map(renderRow)}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const DimensionalSection = ({ data, onChange, imageFileName = "1-EMPAQUE RECUPERABLE TKR1 0101-5000.png" }) => {
            const updateLength = (key, val) => onChange({ ...data, lengths: { ...data.lengths, [key]: val } });
            const updateOd = (key, val) => onChange({ ...data, od: { ...data.od, [key]: val } });
            const updateMaxMin = (key, val) => onChange({ ...data, maxMin: { ...data.maxMin, [key]: val } });
            const updateAccessory = (key, subKey, val) => onChange({ ...data, accessories: { ...data.accessories, [key]: { ...data.accessories[key], [subKey]: val } } });

            return (
                <div className="border border-gray-300 p-4 rounded bg-white">
                    <div className="bg-tackerRed text-white font-bold p-1 text-center mb-4 text-sm uppercase">6. Control Dimensional</div>
                    <div className="flex flex-col md:flex-row gap-8">
                        <div className="w-full md:w-1/3 flex items-start justify-center py-4 bg-white relative">
                            <img src={imageFileName} alt="Diagrama" className="w-full h-auto object-contain max-h-[900px]" onError={(e) => { e.currentTarget.style.display = 'none'; document.getElementById(`err-${imageFileName}`).style.display = 'block'; }} />
                            <div id={`err-${imageFileName}`} className="hidden text-center p-8 border-2 border-dashed border-gray-300 rounded text-gray-500 mt-10">
                                <p className="font-bold text-red-500 mb-2">Imagen no encontrada</p>
                                <p className="text-sm">Asegúrese de que el archivo exista:</p>
                                <code className="block bg-gray-100 p-2 mt-2 font-mono text-black border border-gray-300 rounded text-xs break-all">{imageFileName}</code>
                            </div>
                        </div>
                        <div className="w-full md:w-2/3 space-y-6 text-sm">
                            <div className="flex justify-between items-center pb-2 border-b border-gray-200">
                                <span className="font-bold text-lg">Diametro: <span className="ml-2 font-mono">5"</span></span>
                                <span className="font-bold text-lg">Libraje: <span className="ml-2 font-mono">18#</span></span>
                            </div>
                            <div>
                                <h4 className="font-bold italic mb-2">Máximo y Mínimo Diámetro</h4>
                                <div className="flex flex-col gap-2">
                                    {['od', 'id'].map(k => (
                                        <div key={k} className="flex items-center gap-2">
                                            <label className="w-10 font-bold uppercase">{k}:</label>
                                            <input type="text" value={data.maxMin[k]} onChange={(e) => updateMaxMin(k, e.target.value)} className="border-b border-gray-400 w-32 px-1 focus:outline-none focus:border-tackerRed text-center" />
                                            <span className="text-gray-500">pulg</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-12">
                                <div className="space-y-1">
                                    <h4 className="font-bold italic mb-2">Longitudes</h4>
                                    {['A', 'B', 'C'].map(label => (
                                        <div key={label} className="flex justify-between items-center gap-2">
                                            <label className="font-bold">{label}:</label>
                                            <div className="flex items-center gap-1 flex-1">
                                                <input type="text" value={data.lengths[label] || ''} onChange={(e) => updateLength(label, e.target.value)} className="w-full border-b border-gray-400 text-center px-1 focus:outline-none focus:border-tackerRed" />
                                                <span className="text-gray-500 text-xs">pie</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="space-y-1">
                                    <h4 className="font-bold italic mb-2">Diámetros</h4>
                                    {Array.from({ length: 9 }).map((_, i) => {
                                        const key = `od${i + 1}`;
                                        return (
                                            <div key={key} className="flex justify-between items-center gap-2">
                                                <label className="font-bold text-xs whitespace-nowrap">OD {i + 1}:</label>
                                                <div className="flex items-center gap-1 flex-1">
                                                    <input type="text" value={data.od[key] || ''} onChange={(e) => updateOd(key, e.target.value)} className="w-full border-b border-gray-400 text-center px-1 focus:outline-none focus:border-tackerRed" />
                                                    <span className="text-gray-500 text-xs">pulg</span>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            <div className="mt-4 pt-2">
                                <h4 className="font-bold italic mb-2">Accesorios</h4>
                                <div className="space-y-2">
                                    <div className="flex justify-end gap-3 px-8 text-xs font-bold text-center"><span className="w-4">A</span><span className="w-4">B</span><span className="w-4">U</span><span className="w-4">✔</span></div>
                                    {['piston', 'mordaza', 'block'].map(acc => (
                                        <div key={acc} className="flex items-center justify-between border-b border-dashed border-gray-300 pb-1">
                                            <span className="font-bold capitalize">{acc}:</span>
                                            <div className="flex gap-3 px-8">
                                                {['a', 'b', 'u', 'check'].map(f => <input key={f} type="checkbox" checked={data.accessories[acc][f]} onChange={(e) => updateAccessory(acc, f, e.target.checked)} />)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PreAssemblyChecks = ({ checks, onChange }) => (
            <div className="space-y-2">
                <div className="grid grid-cols-12 gap-2 bg-tackerRed text-white text-sm font-bold p-2 items-center">
                    <div className="col-span-8">2. Controles previos al ensamble</div>
                    <div className="col-span-4 text-right">Responsable</div>
                </div>
                {checks.map((check) => {
                    const validation = !check.isYesNo ? validateMeasurement(check) : 'ok';
                    const borderColor = validation === 'fail' ? 'border-red-500 bg-red-50 text-red-700 font-bold' : validation === 'ok' && check.measuredValue ? 'border-green-500 bg-green-50 text-green-800 font-bold' : 'border-tackerRed bg-gray-50';
                    return (
                        <div key={check.id} className="border-b border-gray-200 pb-2 mb-2">
                            <div className="flex flex-col md:flex-row md:items-start justify-between">
                                <div className="w-full md:w-2/3 pr-2">
                                    <span className="font-bold text-sm mr-1">{check.id}.</span>
                                    <span className="text-sm text-gray-800">{check.description}</span>
                                    {!check.isYesNo && check.hasMeasurement && (
                                        <div className="mt-1 text-xs text-gray-500 flex gap-4">
                                            <span>Nominal: <strong>{check.nominalValue}{check.nominalUnit}</strong></span>
                                            <span>Aceptable: <strong>{check.acceptableValue}{check.nominalUnit}</strong></span>
                                            {validation === 'fail' && <span className="text-red-600 font-bold animate-pulse">⚠️ FUERA DE TOLERANCIA</span>}
                                        </div>
                                    )}
                                </div>
                                <div className="w-full md:w-1/3 flex items-center justify-end mt-2 md:mt-0 gap-2">
                                    {check.isYesNo ? (
                                        <label className="flex items-center space-x-2 cursor-pointer">
                                            <span className={`text-sm font-bold ${check.checked ? 'text-green-700' : 'text-gray-400'}`}>{check.checked ? 'APROBADO' : 'PENDIENTE'}</span>
                                            <input type="checkbox" checked={check.checked || false} onChange={(e) => onChange(check.id, e.target.checked)} className="w-5 h-5 text-tackerRed rounded border-gray-300 focus:ring-tackerRed" />
                                        </label>
                                    ) : (
                                        <div className="flex items-center space-x-2">
                                            <span className="text-xs text-gray-600">Medida:</span>
                                            <div className="relative">
                                                <input type="text" value={check.measuredValue || ''} onChange={(e) => onChange(check.id, e.target.value)} className={`w-24 border-b-2 px-2 py-1 text-center font-mono outline-none transition-colors ${borderColor}`} placeholder="0.00" />
                                                <span className="absolute right-1 top-1 text-xs text-gray-400">mm</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        );

        const TraceabilityTable = ({ data, onChange }) => (
            <div className="overflow-x-auto shadow-sm border border-gray-300 rounded-sm">
                <table className="w-full text-xs md:text-sm text-left border-collapse">
                    <thead className="bg-gray-100 font-bold text-gray-700">
                        <tr>
                            <th className="border p-2 w-24">Código</th>
                            <th className="border p-2">Descripción</th>
                            <th className="border p-2 w-20">Lote</th>
                            <th className="border p-2 w-20">Serie</th>
                            <th className="border p-2 w-12 text-center">Si</th>
                            <th className="border p-2 w-1/4">Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {data.map((item, index) => (
                            <tr key={item.id} className={index % 2 === 0 ? "bg-white" : "bg-gray-50"}>
                                <td className="border p-1 text-gray-800 font-mono">{item.code}</td>
                                <td className="border p-1">{item.description}</td>
                                <td className="border p-1"><input type="text" value={item.lot} onChange={(e) => onChange(item.id, 'lot', e.target.value)} className="w-full bg-transparent outline-none focus:bg-blue-50" placeholder="-" /></td>
                                <td className="border p-1"><input type="text" value={item.serie} onChange={(e) => onChange(item.id, 'serie', e.target.value)} className="w-full bg-transparent outline-none focus:bg-blue-50" placeholder="-" /></td>
                                <td className="border p-1 text-center"><input type="checkbox" checked={item.checked} onChange={(e) => onChange(item.id, 'checked', e.target.checked)} className="h-4 w-4 text-tackerRed focus:ring-tackerRed" /></td>
                                <td className="border p-1"><input type="text" value={item.observations} onChange={(e) => onChange(item.id, 'observations', e.target.value)} className="w-full bg-transparent outline-none focus:bg-blue-50 text-gray-600 italic" /></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );

        // --- CHECKLIST VIEWS ---

        const ChecklistTemplate = ({ onBack, title, initialTraceability, initialChecks, initialInstruments, imageFile }) => {
             const [data, setData] = useState({
                meta: { date: new Date().toISOString().split('T')[0], serial: 'BC-', reportNumber: 'POCOP001-A2-4' },
                traceability: initialTraceability || INITIAL_TRACEABILITY,
                preAssemblyChecks: initialChecks || INITIAL_CHECKS,
                attachments: { lastJob: '', inspectionReport: '', incidentReport: '', hydroTestPsi: '', hydroTestMin: '' },
                functionalTest: { systemSetting: '', mandrelPass: false },
                comments: '',
                dimensional: { maxMin: { od: '', id: '' }, od: {}, lengths: {}, accessories: { piston: { a: false, b: false, u: false, check: false }, mordaza: { a: false, b: false, u: false, check: false }, block: { a: false, b: false, u: false, check: false }, connUpper: '', connLower: '' } },
                instruments: initialInstruments || INITIAL_INSTRUMENTS,
                signatures: { assembledBy: '', assembledDate: '', assembledSignature: '', supervisedBy: '', supervisedDate: '', supervisedSignature: '' },
                photos: { section1: [], section2: [], section3: [] }
            });

            const handleTraceabilityChange = (id, field, value) => setData(p => ({...p, traceability: p.traceability.map(i => i.id === id ? {...i, [field]: value} : i)}));
            const handleCheckChange = (id, value) => setData(p => ({...p, preAssemblyChecks: p.preAssemblyChecks.map(i => i.id === id ? (i.isYesNo ? {...i, checked: value} : {...i, measuredValue: value}) : i)}));
            const handleInstrumentChange = (id, field, value) => setData(p => ({...p, instruments: p.instruments.map(i => i.id === id ? {...i, [field]: value} : i)}));
            const toolEvaluation = useMemo(() => evaluateToolStatus(data), [data]);

            return (
                <div className="min-h-screen bg-gray-200 p-4 md:p-8 font-sans">
                    <div className="max-w-5xl mx-auto mb-4 print:hidden">
                        <button onClick={onBack} className="flex items-center text-gray-600 hover:text-tackerRed transition font-medium"><ArrowLeft size={20} className="mr-2" /> Volver al Inicio</button>
                    </div>
                    <div className="max-w-5xl mx-auto bg-white shadow-2xl overflow-hidden print:shadow-none print:w-full">
                        <header className="border-b-4 border-tackerRed p-6 flex flex-col md:flex-row justify-between items-center bg-white sticky top-0 z-10 shadow-sm print:static print:shadow-none">
                            <div className="flex items-center space-x-4">
                                <div className="text-3xl font-black italic tracking-tighter text-tackerRed">TACKER<span className="block text-xs font-normal text-black not-italic -mt-1 ml-1 tracking-widest">SOLUTIONS</span></div>
                                <div><h1 className="text-xl font-bold text-gray-800 uppercase">Informe de Reparación</h1>
                                    <div className="print:hidden mt-2">
                                        {toolEvaluation.status === 'APTO' && <span className="inline-flex items-center gap-1 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold border border-green-300"><CheckCircle size={14} /> APTO</span>}
                                        {toolEvaluation.status === 'NO APTO' && <span className="inline-flex items-center gap-1 bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold border border-red-300 animate-pulse"><XCircle size={14} /> NO APTO</span>}
                                        {toolEvaluation.status === 'INCOMPLETO' && <span className="inline-flex items-center gap-1 bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold border border-yellow-300"><AlertTriangle size={14} /> INCOMPLETO</span>}
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col items-end mt-4 md:mt-0 text-sm">
                                <div className="font-mono font-bold text-lg">{data.meta.reportNumber}</div>
                                <div className="flex gap-4 mt-1">
                                    <label className="flex items-center gap-2"><span className="font-bold">Fecha:</span><input type="date" value={data.meta.date} onChange={(e) => setData({...data, meta: {...data.meta, date: e.target.value}})} className="border-b border-gray-300 focus:border-tackerRed outline-none" /></label>
                                    <label className="flex items-center gap-2"><span className="font-bold">Serial:</span><input type="text" value={data.meta.serial} onChange={(e) => setData({...data, meta: {...data.meta, serial: e.target.value}})} className="w-24 border-b border-gray-300 focus:border-tackerRed outline-none" /></label>
                                </div>
                            </div>
                        </header>
                        {toolEvaluation.status === 'NO APTO' && <div className="bg-red-50 border-b border-red-200 p-4 text-sm text-red-800 print:hidden"><p className="font-bold">Fallos:</p><ul className="list-disc ml-5">{toolEvaluation.reasons.map((r, i) => <li key={i}>{r}</li>)}</ul></div>}
                        <div className="bg-gray-100 border-b border-gray-300 p-3 text-center"><h2 className="text-lg font-bold text-gray-800 uppercase tracking-wide">{title}</h2></div>
                        <div className="p-6 space-y-6">
                            <section><div className="bg-tackerRed text-white px-3 py-1 font-bold text-sm mb-2 rounded-t-sm uppercase">1. Trazabilidad</div><TraceabilityTable data={data.traceability} onChange={handleTraceabilityChange} /></section>
                            <section><PreAssemblyChecks checks={data.preAssemblyChecks} onChange={handleCheckChange} /></section>
                            <section className="bg-tackerRed text-white px-3 py-1 font-bold text-sm rounded-sm uppercase">3. Adjuntos & 4. Funcional (Simplificado)</section>
                            <section><div className="bg-tackerRed text-white px-3 py-1 font-bold text-sm mb-0 rounded-t-sm uppercase">5. Comentarios</div><div className="border border-gray-300 p-2 bg-white"><textarea className="w-full h-24 p-2 outline-none resize-none" value={data.comments} onChange={(e) => setData({...data, comments: e.target.value})}></textarea></div></section>
                            <section className="break-before-page">
                                <DimensionalSection data={data.dimensional} onChange={(newDim) => setData({...data, dimensional: newDim})} imageFileName={imageFile} />
                                <InstrumentsTable instruments={data.instruments} onChange={handleInstrumentChange} />
                            </section>
                            <section className="mt-8">
                                <div className="bg-tackerRed text-white px-3 py-1 font-bold text-sm mb-6 text-center rounded-sm uppercase">7. Responsabilidades</div>
                                <div className="grid grid-cols-2 gap-12">
                                    <div className="text-center"><h4 className="font-bold text-lg mb-8 italic">Ensambló</h4><SignaturePad value={data.signatures.assembledSignature} onChange={(v) => setData(p => ({...p, signatures: {...p.signatures, assembledSignature: v}}))} /></div>
                                    <div className="text-center"><h4 className="font-bold text-lg mb-8 italic">Supervisó</h4><SignaturePad value={data.signatures.supervisedSignature} onChange={(v) => setData(p => ({...p, signatures: {...p.signatures, supervisedSignature: v}}))} /></div>
                                </div>
                            </section>
                            <section className="grid grid-cols-1 gap-4 break-before-page">
                                <PhotoPlaceholder title="Foto 1" images={data.photos.section1} onAdd={(imgs) => setData(p => ({...p, photos: {...p.photos, section1: [...p.photos.section1, ...imgs]}}))} onRemove={(i) => setData(p => ({...p, photos: {...p.photos, section1: p.photos.section1.filter((_, idx) => idx !== i)}}))} />
                                {/* Add other placeholders as needed */}
                            </section>
                        </div>
                        <div className="fixed bottom-6 right-6 flex flex-col gap-3 print:hidden">
                            <button className="bg-tackerRed text-white p-4 rounded-full shadow-lg" onClick={() => window.print()}><Printer size={24} /></button>
                        </div>
                    </div>
                </div>
            );
        };

        const Home = ({ onNavigate }) => (
            <div className="min-h-screen bg-gray-100 font-sans flex flex-col">
                <header className="bg-white shadow-sm border-b-4 border-tackerRed"><div className="max-w-6xl mx-auto px-4 py-6"><span className="text-3xl font-black italic tracking-tighter text-tackerRed">TACKER</span></div></header>
                <main className="flex-1 max-w-6xl mx-auto px-4 py-12 w-full">
                    <div className="text-center mb-12"><h1 className="text-3xl font-bold text-gray-800">Seleccione un Informe</h1></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {[
                            { id: 'checklist-001', title: 'Empaque TKR1 (5")', subtitle: '0101-5000' },
                            { id: 'checklist-5500', title: 'Empaque TKR1 (5 1/2")', subtitle: '0101-5500' },
                            { id: 'checklist-0178', title: 'Empaque TKR1 (7")', subtitle: '0178-5000' }
                        ].map(c => (
                            <div key={c.id} onClick={() => onNavigate(c.id)} className="bg-white rounded-lg shadow-md p-6 hover:shadow-xl cursor-pointer border-t-4 hover:border-t-tackerRed transition-all">
                                <h3 className="text-lg font-bold">{c.title}</h3>
                                <p className="text-sm text-gray-500">{c.subtitle}</p>
                            </div>
                        ))}
                    </div>
                </main>
            </div>
        );

        // --- APP ROOT ---
        const App = () => {
            const [view, setView] = useState('home');
            
            // Render view logic
            if (view === 'checklist-001') return <ChecklistTemplate onBack={() => setView('home')} title="Empaque TKR1 0101-5000" imageFile="1-EMPAQUE RECUPERABLE TKR1 0101-5000.png" />;
            if (view === 'checklist-0178') return <ChecklistTemplate onBack={() => setView('home')} title="Empaque TKR1 0178-5000" initialTraceability={INITIAL_TRACEABILITY_0178} initialChecks={INITIAL_CHECKS_0178} imageFile="1-EMPAQUE RECUPERABLE TKR1 0178-5000.png" />;
            if (view === 'checklist-5500') return <ChecklistTemplate onBack={() => setView('home')} title="Empaque TKR1 0101-5500" initialTraceability={INITIAL_TRACEABILITY_5500} initialChecks={INITIAL_CHECKS_5500} imageFile="1-EMPAQUE RECUPERABLE TKR1 0101-5500.png" />;
            
            return <Home onNavigate={setView} />;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>